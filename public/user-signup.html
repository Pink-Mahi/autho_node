<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account - Bitcoin Ownership Protocol</title>
    
    <!-- Bitcoin Libraries (CDN) -->
    <script src="https://bundle.run/bip39@3.0.4"></script>
    <script src="https://bundle.run/bip32@2.0.6"></script>
    <script src="https://bundle.run/bitcoinjs-lib@6.0.1"></script>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #d4af37;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            border: 2px solid #d4af37;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.2);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            text-align: center;
            color: #999;
            margin-bottom: 30px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #d4af37;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background: rgba(42, 42, 42, 0.8);
            border: 1px solid #555;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #d4af37;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            border: none;
            border-radius: 10px;
            color: #0a0a0a;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .btn-secondary {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
            border: 1px solid #d4af37;
        }

        .seed-phrase {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .seed-words {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .seed-word {
            background: rgba(42, 42, 42, 0.8);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #555;
        }

        .seed-word span {
            color: #999;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .warning {
            background: rgba(255, 149, 0, 0.1);
            border: 1px solid #ff9500;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #ff9500;
        }

        .warning strong {
            display: block;
            margin-bottom: 5px;
        }

        .checkbox-group {
            margin: 20px 0;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .wallet-info {
            background: rgba(76, 217, 100, 0.1);
            border: 1px solid #4cd964;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .wallet-info h3 {
            color: #4cd964;
            margin-bottom: 10px;
        }

        .address-display {
            background: rgba(42, 42, 42, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
            color: #fff;
        }

        .progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: rgba(42, 42, 42, 0.5);
            border-radius: 5px;
            margin: 0 5px;
            opacity: 0.5;
        }

        .progress-step.active {
            opacity: 1;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
        }

        .copy-btn {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            color: #d4af37;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: rgba(212, 175, 55, 0.3);
        }

        .qr-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .qr-code-container {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 15px 0;
        }

        .print-btn {
            background: linear-gradient(135deg, #4cd964 0%, #2ecc71 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 5px;
        }

        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 217, 100, 0.4);
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .qr-section, .qr-section * {
                visibility: visible;
            }
            .qr-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
            }
            .print-btn, .copy-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Create Your Account</h1>
        <p class="subtitle">Non-Custodial Bitcoin & Lightning Wallet</p>

        <div class="progress">
            <div class="progress-step active" id="progress1">1. Account</div>
            <div class="progress-step" id="progress2">2. Wallet</div>
            <div class="progress-step" id="progress3">3. Backup</div>
            <div class="progress-step" id="progress4">4. Confirm</div>
        </div>

        <!-- Step 1: Account Info -->
        <div class="step active" id="step1">
            <h2 style="margin-bottom: 20px;">Account Information</h2>
            
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="username" placeholder="Choose a username" required>
            </div>

            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="email" placeholder="your@email.com" required>
            </div>

            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="password" placeholder="Strong password" required>
            </div>

            <div class="form-group">
                <label>Confirm Password *</label>
                <input type="password" id="confirmPassword" placeholder="Confirm password" required>
            </div>

            <button class="btn" onclick="goToStep2()">Next: Create Wallet ‚Üí</button>
        </div>

        <!-- Step 2: Wallet Generation -->
        <div class="step" id="step2">
            <h2 style="margin-bottom: 20px;">Generate Your Wallet</h2>
            
            <p style="color: #999; margin-bottom: 20px;">
                We'll create a Bitcoin wallet for you. You'll receive a 12-word seed phrase that gives you complete control over your funds.
            </p>

            <div class="warning">
                <strong>‚ö†Ô∏è Important:</strong>
                Your wallet is generated in YOUR browser. We never see or store your private keys. You are in complete control.
            </div>

            <div class="form-group">
                <label>Enable Lightning Network? (Optional)</label>
                <select id="enableLightning">
                    <option value="no">No - Bitcoin Only</option>
                    <option value="yes">Yes - Bitcoin + Lightning</option>
                </select>
                <small style="color: #999; display: block; margin-top: 5px;">
                    Lightning enables instant, low-fee payments
                </small>
            </div>

            <button class="btn" onclick="generateWallet()">üîë Generate My Wallet</button>
            <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
        </div>

        <!-- Step 3: Seed Phrase Backup -->
        <div class="step" id="step3">
            <h2 style="margin-bottom: 20px;">Backup Your Seed Phrase</h2>
            
            <div class="warning">
                <strong>üö® CRITICAL:</strong>
                Write down these 12 words in order. This is the ONLY way to recover your wallet. If you lose this, your funds are GONE FOREVER. We cannot help you recover it.
            </div>

            <div class="seed-phrase">
                <h3 style="color: #d4af37; margin-bottom: 15px;">Your Seed Phrase</h3>
                <div class="seed-words" id="seedWords"></div>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="copy-btn" onclick="copySeedPhrase()" style="flex: 1; min-width: 150px;">üìã Copy to Clipboard</button>
                    <button class="copy-btn" onclick="downloadSeedPhrase()" style="flex: 1; min-width: 150px;">üíæ Download as Text</button>
                </div>
            </div>

            <div class="qr-section">
                <h3 style="color: #0a0a0a; margin-bottom: 10px;">üì± QR Code Backup</h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                    Scan this QR code to restore your wallet on any device
                </p>
                <div class="qr-code-container" id="qrCodeContainer"></div>
                <div>
                    <button class="print-btn" onclick="printQRCode()">üñ®Ô∏è Print QR Code</button>
                    <button class="copy-btn" onclick="downloadQRCode()">üíæ Download QR Code</button>
                </div>
                <p style="color: #ff9500; font-size: 0.85rem; margin-top: 15px;">
                    ‚ö†Ô∏è Keep this QR code as safe as your seed phrase!
                </p>
            </div>

            <div class="wallet-info">
                <h3>Your Bitcoin Address</h3>
                <div class="address-display" id="bitcoinAddress"></div>
                
                <div id="lightningInfo" style="display: none; margin-top: 15px;">
                    <h3>Your Lightning Address</h3>
                    <div class="address-display" id="lightningAddress"></div>
                </div>
            </div>

            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="backedUp">
                    I have written down my seed phrase in a safe place
                </label>
            </div>

            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="understand">
                    I understand that if I lose my seed phrase, I will lose access to my funds
                </label>
            </div>

            <button class="btn" onclick="goToStep4()" id="continueBtn" disabled>Continue ‚Üí</button>
            <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
        </div>

        <!-- Step 4: Confirm & Complete -->
        <div class="step" id="step4">
            <h2 style="margin-bottom: 20px;">Confirm Your Seed Phrase</h2>
            
            <p style="color: #999; margin-bottom: 20px;">
                To ensure you've backed up your seed phrase correctly, please enter words #3, #7, and #11:
            </p>

            <div class="form-group">
                <label>Word #3</label>
                <input type="text" id="word3" placeholder="Enter word #3">
            </div>

            <div class="form-group">
                <label>Word #7</label>
                <input type="text" id="word7" placeholder="Enter word #7">
            </div>

            <div class="form-group">
                <label>Word #11</label>
                <input type="text" id="word11" placeholder="Enter word #11">
            </div>

            <div id="verificationError" style="color: #ff3b30; margin: 10px 0; display: none;"></div>

            <button class="btn" onclick="completeSignup()">‚úÖ Complete Signup</button>
            <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
        </div>
    </div>

    <script src="/wallet-generator.js"></script>
    <script>
        let walletData = {
            mnemonic: '',
            bitcoinAddress: '',
            lightningAddress: '',
            publicKey: ''
        };

        let userData = {};

        function goToStep(stepNum) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.progress-step').forEach(s => s.classList.remove('active'));
            
            document.getElementById('step' + stepNum).classList.add('active');
            document.getElementById('progress' + stepNum).classList.add('active');
        }

        function goToStep2() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!username || !email || !password) {
                alert('Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            userData = { username, email, password };
            goToStep(2);
        }

        function generateWallet() {
            try {
                // Generate Bitcoin wallet (client-side only!)
                const wallet = WalletGenerator.generateBitcoinWallet();
                
                walletData.mnemonic = wallet.mnemonic;
                walletData.bitcoinAddress = wallet.address;
                walletData.publicKey = wallet.publicKey;

                // Generate Lightning address if enabled
                const enableLightning = document.getElementById('enableLightning').value === 'yes';
                if (enableLightning) {
                    walletData.lightningAddress = WalletGenerator.generateLightningAddress(userData.username);
                    document.getElementById('lightningInfo').style.display = 'block';
                    document.getElementById('lightningAddress').textContent = walletData.lightningAddress;
                }

                // Display seed phrase
                const words = walletData.mnemonic.split(' ');
                const seedWordsDiv = document.getElementById('seedWords');
                seedWordsDiv.innerHTML = '';
                
                words.forEach((word, index) => {
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'seed-word';
                    wordDiv.innerHTML = `<span>${index + 1}.</span>${word}`;
                    seedWordsDiv.appendChild(wordDiv);
                });

                // Display Bitcoin address
                document.getElementById('bitcoinAddress').textContent = walletData.bitcoinAddress;

                // Generate QR code for seed phrase
                generateSeedQRCode();

                goToStep(3);
            } catch (error) {
                alert('Error generating wallet: ' + error.message);
                console.error(error);
            }
        }

        function generateSeedQRCode() {
            const qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.innerHTML = ''; // Clear previous QR code
            
            // Create QR code from seed phrase
            new QRCode(qrContainer, {
                text: walletData.mnemonic,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H // High error correction
            });
        }

        function printQRCode() {
            window.print();
        }

        function downloadQRCode() {
            const qrContainer = document.getElementById('qrCodeContainer');
            const canvas = qrContainer.querySelector('canvas');
            
            if (canvas) {
                // Convert canvas to blob
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `wallet-backup-${userData.username}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert('‚úÖ QR code downloaded! Keep this file safe and secure.');
                });
            }
        }

        function copySeedPhrase() {
            navigator.clipboard.writeText(walletData.mnemonic);
            alert('‚úÖ Seed phrase copied to clipboard!\n\n‚ö†Ô∏è Paste it somewhere safe immediately.');
        }

        function downloadSeedPhrase() {
            const seedText = `BITCOIN WALLET SEED PHRASE
============================

Username: ${userData.username}
Created: ${new Date().toLocaleString()}

SEED PHRASE (12 words):
${walletData.mnemonic}

Bitcoin Address:
${walletData.bitcoinAddress}

${walletData.lightningAddress ? `Lightning Address:\n${walletData.lightningAddress}\n\n` : ''}
‚ö†Ô∏è CRITICAL SECURITY WARNING ‚ö†Ô∏è
================================
This seed phrase gives COMPLETE CONTROL over your Bitcoin wallet.
Anyone with these words can access and spend your funds.

KEEP THIS FILE SECURE:
- Store in encrypted folder
- Use strong password protection
- Never share with anyone
- Never upload to cloud unencrypted
- Make multiple backup copies
- Store in different secure locations

If you lose this seed phrase, you will PERMANENTLY lose access to your funds.
We cannot help you recover it.

============================
Bitcoin Ownership Protocol
Non-Custodial Wallet Backup
============================`;

            const blob = new Blob([seedText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wallet-seed-${userData.username}-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Seed phrase downloaded!\n\n‚ö†Ô∏è IMPORTANT:\n‚Ä¢ Encrypt this file immediately\n‚Ä¢ Store in a secure location\n‚Ä¢ Never share with anyone');
        }

        // Enable continue button when both checkboxes are checked
        document.addEventListener('DOMContentLoaded', () => {
            const backedUp = document.getElementById('backedUp');
            const understand = document.getElementById('understand');
            const continueBtn = document.getElementById('continueBtn');

            function checkBoxes() {
                continueBtn.disabled = !(backedUp.checked && understand.checked);
            }

            if (backedUp && understand) {
                backedUp.addEventListener('change', checkBoxes);
                understand.addEventListener('change', checkBoxes);
            }
        });

        function goToStep4() {
            goToStep(4);
        }

        async function completeSignup() {
            const words = walletData.mnemonic.split(' ');
            const word3 = document.getElementById('word3').value.trim().toLowerCase();
            const word7 = document.getElementById('word7').value.trim().toLowerCase();
            const word11 = document.getElementById('word11').value.trim().toLowerCase();

            // Verify seed phrase
            if (word3 !== words[2] || word7 !== words[6] || word11 !== words[10]) {
                document.getElementById('verificationError').textContent = 
                    '‚ùå Incorrect words. Please check your seed phrase backup.';
                document.getElementById('verificationError').style.display = 'block';
                return;
            }

            // Create account (send only public data to server)
            try {
                const response = await fetch('/api/users/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: userData.username,
                        email: userData.email,
                        password: userData.password,
                        // ONLY send public addresses - NEVER private keys!
                        bitcoinAddress: walletData.bitcoinAddress,
                        lightningAddress: walletData.lightningAddress || null,
                        publicKey: walletData.publicKey
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ Account created successfully!\n\n‚ö†Ô∏è Make sure you have saved your seed phrase!');
                    // Redirect to login or dashboard
                    window.location.href = '/m';
                } else {
                    alert('Error: ' + (data.error || 'Failed to create account'));
                }
            } catch (error) {
                alert('Error creating account: ' + error.message);
            }
        }
    </script>
</body>
</html>
